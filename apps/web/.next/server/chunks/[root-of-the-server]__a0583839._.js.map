{"version":3,"sources":["../../../lib/auth-utils.ts","../../../lib/muscle-tags.ts","../../../lib/form-tips.ts"],"sourcesContent":["// lib/auth-utils.ts\n// Helper utilities for authentication in API routes\n\nimport { auth } from \"@/auth\"\nimport { NextResponse } from \"next/server\"\n\nexport interface AuthenticatedUser {\n  id: string\n  email: string\n  name?: string | null\n  image?: string | null\n}\n\n/**\n * Get the current authenticated user from the session.\n * Returns null if not authenticated.\n */\nexport async function getCurrentUser(): Promise<AuthenticatedUser | null> {\n  const session = await auth()\n\n  if (!session?.user?.email) {\n    return null\n  }\n\n  return {\n    id: session.user.email, // We use email as the user ID\n    email: session.user.email,\n    name: session.user.name,\n    image: session.user.image,\n  }\n}\n\n/**\n * Require authentication for an API route.\n * Returns the user if authenticated, or a 401 response if not.\n */\nexport async function requireAuth(): Promise<\n  { user: AuthenticatedUser } | { error: NextResponse }\n> {\n  if (process.env.E2E_TEST === \"1\") {\n    return {\n      user: {\n        id: \"e2e@test.local\",\n        email: \"e2e@test.local\",\n        name: \"E2E User\",\n      },\n    }\n  }\n\n  const user = await getCurrentUser()\n\n  if (!user) {\n    return {\n      error: NextResponse.json(\n        { error: \"Unauthorized\" },\n        { status: 401 }\n      ),\n    }\n  }\n\n  return { user }\n}\n","export const MUSCLE_GROUP_TAGS = [\n  'lower body compound',\n  'upper body compound',\n  'full body compound',\n  'chest',\n  'back',\n  'shoulders',\n  'biceps',\n  'triceps',\n  'forearms',\n  'core',\n  'lower back',\n  'glutes',\n  'quads',\n  'hamstrings',\n  'calves',\n  'hip flexors',\n  'adductors',\n  'abductors',\n  'unknown',\n] as const;\n\nexport const STRETCH_MUSCLE_TAGS = [...MUSCLE_GROUP_TAGS] as const;\n\nexport const MUSCLE_GROUP_ORDER = [...MUSCLE_GROUP_TAGS];\nexport const STRETCH_MUSCLE_ORDER = [...STRETCH_MUSCLE_TAGS];\n\nexport function normalizeTypeList(\n  value: unknown,\n  allowed?: readonly string[],\n  maxItems = 2\n): string[] {\n  const entries = Array.isArray(value)\n    ? value\n    : typeof value === 'string'\n      ? [value]\n      : [];\n  if (entries.length === 0) return [];\n  const cleaned = entries\n    .map((item) => (typeof item === 'string' ? item.trim().toLowerCase() : ''))\n    .filter(Boolean);\n  const filtered = allowed ? cleaned.filter((tag) => allowed.includes(tag)) : cleaned;\n  const unique: string[] = [];\n  for (const tag of filtered) {\n    if (!unique.includes(tag)) {\n      unique.push(tag);\n    }\n    if (unique.length >= maxItems) break;\n  }\n  return unique;\n}\n\nexport function parseTagJson(\n  value: string | null | undefined,\n  allowed?: readonly string[],\n  maxItems = 2\n): string[] {\n  if (!value) return [];\n  try {\n    const parsed = JSON.parse(value);\n    return normalizeTypeList(parsed, allowed, maxItems);\n  } catch {\n    return [];\n  }\n}\n\nexport function formatTypeLabel(value: string): string {\n  return value\n    .split(' ')\n    .map((word) => (word ? word[0].toUpperCase() + word.slice(1) : word))\n    .join(' ');\n}\n","import {\n  MUSCLE_GROUP_TAGS,\n  STRETCH_MUSCLE_TAGS,\n  normalizeTypeList,\n} from './muscle-tags';\n\nconst DEFAULT_MODEL = process.env.OPENAI_MODEL || 'gpt-4o-mini';\nconst DIFFICULTY_LABELS: Record<string, string> = {\n  beginner: 'Beginner',\n  intermediate: 'Intermediate',\n  medium: 'Intermediate',\n  advanced: 'Advanced',\n};\n\ntype TipRequest = {\n  kind: 'exercise' | 'stretch';\n  name: string;\n  muscleGroups?: string[];\n  equipment?: string;\n  difficulty?: string;\n  timerSeconds?: number;\n  goalsText?: string | null;\n};\n\nfunction formatList(items?: string[]): string {\n  if (!items || items.length === 0) return 'Unknown';\n  return items.join(', ');\n}\n\nfunction buildUserPrompt(data: TipRequest): string {\n  const goalsLine = data.goalsText ? `User goals: ${data.goalsText}` : 'User goals: (not provided)';\n  if (data.kind === 'stretch') {\n    return [\n      `Stretch: ${data.name}`,\n      `Timer seconds: ${data.timerSeconds ?? 'Unknown'}`,\n      `Muscle groups: ${formatList(data.muscleGroups)}`,\n      goalsLine,\n      'Provide 1-2 concise form tips with posture and breathing cues.'\n    ].join('\\n');\n  }\n\n  return [\n    `Exercise: ${data.name}`,\n    `Muscle groups: ${formatList(data.muscleGroups)}`,\n    `Equipment: ${data.equipment || 'Unknown'}`,\n    `Difficulty: ${data.difficulty || 'Unknown'}`,\n    goalsLine,\n    'Provide 1-2 concise form tips with safe technique cues.'\n  ].join('\\n');\n}\n\nfunction normalizeDifficulty(value: unknown): string | null {\n  if (typeof value !== 'string') return null;\n  const cleaned = value.trim().toLowerCase();\n  if (!cleaned || cleaned === 'unknown') return null;\n  return DIFFICULTY_LABELS[cleaned] || null;\n}\n\nfunction normalizeTipOutput(value: string): string {\n  return value\n    .replace(/^[\\s\"'`*-]+/, '')\n    .replace(/[\\s\"'`]+$/, '')\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\nfunction extractJson(content: string): string {\n  const fencedMatch = content.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/i);\n  if (fencedMatch?.[1]) {\n    return fencedMatch[1];\n  }\n  return content;\n}\n\nexport type ExerciseInsights = {\n  tips: string | null;\n  isBodyweight: boolean | null;\n  muscleGroups: string[] | null;\n  difficulty: string | null;\n};\n\nexport type StretchInsights = {\n  tips: string | null;\n  timerSeconds: number | null;\n  muscleGroups: string[] | null;\n};\n\nexport async function generateExerciseInsights(data: TipRequest): Promise<ExerciseInsights | null> {\n  if (!process.env.OPENAI_API_KEY) {\n    return null;\n  }\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        model: DEFAULT_MODEL,\n        messages: [\n          {\n            role: 'system',\n            content: [\n              'You are a gym trainer helping users make consistent progress.',\n              'Return JSON only: {\"tips\":\"...\",\"isBodyweight\":true|false,\"muscleGroups\":[\"chest\",\"upper body compound\"],\"difficulty\":\"Intermediate\"}.',\n              `muscleGroups must be 1-2 items from: ${MUSCLE_GROUP_TAGS.join(', ')}.`,\n              'difficulty must be one of: Beginner, Intermediate, Advanced.',\n              'Use \"unknown\" if the muscle group is unclear.',\n              'If the exercise is a compound movement, include one compound tag and one primary muscle tag when possible.',\n              'tips should be 1-2 short sentences, no markdown.'\n            ].join(' ')\n          },\n          { role: 'user', content: buildUserPrompt(data) }\n        ],\n        temperature: 0.3,\n        max_tokens: 120,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('OpenAI exercise insights request failed:', errorText);\n      return null;\n    }\n\n    const payload = await response.json();\n    const content = payload.choices?.[0]?.message?.content?.trim();\n    if (!content) {\n      return null;\n    }\n\n    const rawJson = extractJson(content);\n    const parsed = JSON.parse(rawJson);\n    const tips = typeof parsed.tips === 'string' ? normalizeTipOutput(parsed.tips) : null;\n    const isBodyweight = typeof parsed.isBodyweight === 'boolean' ? parsed.isBodyweight : null;\n    const muscleGroups = normalizeTypeList(\n      parsed.muscleGroups ?? parsed.exerciseTypes,\n      MUSCLE_GROUP_TAGS\n    );\n    const difficulty = normalizeDifficulty(parsed.difficulty);\n    return {\n      tips: tips && tips.length > 0 ? tips : null,\n      isBodyweight,\n      muscleGroups: muscleGroups.length > 0 ? muscleGroups : null,\n      difficulty,\n    };\n  } catch (error) {\n    console.error('OpenAI exercise insights request error:', error);\n    return null;\n  }\n}\n\nexport async function generateStretchInsights(data: TipRequest): Promise<StretchInsights | null> {\n  if (!process.env.OPENAI_API_KEY) {\n    return null;\n  }\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        model: DEFAULT_MODEL,\n        messages: [\n          {\n            role: 'system',\n            content: [\n              'You are a gym trainer helping users make consistent progress.',\n              'Return JSON only: {\"tips\":\"...\",\"timerSeconds\":30,\"muscleGroups\":[\"hamstrings\",\"glutes\"]}.',\n              `muscleGroups must be 1-2 items from: ${STRETCH_MUSCLE_TAGS.join(', ')}.`,\n              'Use \"unknown\" if the muscle group is unclear.',\n              'timerSeconds is the hold time in seconds (integer).',\n              'tips should be 1-2 short sentences, no markdown.'\n            ].join(' ')\n          },\n          { role: 'user', content: buildUserPrompt(data) }\n        ],\n        temperature: 0.3,\n        max_tokens: 160,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('OpenAI stretch insights request failed:', errorText);\n      return null;\n    }\n\n    const payload = await response.json();\n    const content = payload.choices?.[0]?.message?.content?.trim();\n    if (!content) {\n      return null;\n    }\n\n    const rawJson = extractJson(content);\n    const parsed = JSON.parse(rawJson);\n    const tips = typeof parsed.tips === 'string' ? normalizeTipOutput(parsed.tips) : null;\n    const timerSecondsRaw = Number(parsed.timerSeconds);\n    const timerSeconds = Number.isFinite(timerSecondsRaw) && timerSecondsRaw > 0\n      ? Math.round(timerSecondsRaw)\n      : null;\n    const muscleGroups = normalizeTypeList(parsed.muscleGroups ?? parsed.stretchTypes, STRETCH_MUSCLE_TAGS);\n    return {\n      tips: tips && tips.length > 0 ? tips : null,\n      timerSeconds,\n      muscleGroups: muscleGroups.length > 0 ? muscleGroups : null,\n    };\n  } catch (error) {\n    console.error('OpenAI stretch insights request error:', error);\n    return null;\n  }\n}\n\nexport async function generateFormTips(data: TipRequest): Promise<string | null> {\n  if (!process.env.OPENAI_API_KEY) {\n    return null;\n  }\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        model: DEFAULT_MODEL,\n        messages: [\n          {\n            role: 'system',\n            content: 'You are a gym trainer helping users make consistent progress. Return 1-2 short sentences. No markdown or bullet points.'\n          },\n          { role: 'user', content: buildUserPrompt(data) }\n        ],\n        temperature: 0.3,\n        max_tokens: 80,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('OpenAI tips request failed:', errorText);\n      return null;\n    }\n\n    const payload = await response.json();\n    const content = payload.choices?.[0]?.message?.content?.trim();\n    if (!content) {\n      return null;\n    }\n\n    const normalized = normalizeTipOutput(content);\n    return normalized.length > 0 ? normalized : null;\n  } catch (error) {\n    console.error('OpenAI tips request error:', error);\n    return null;\n  }\n}\n"],"names":[],"mappings":"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"}